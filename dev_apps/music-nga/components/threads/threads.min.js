(function p(f,d,g){function m(e,b){if(!d[e]){if(!f[e]){var c="function"==typeof require&&require;if(!b&&c)return c(e,!0);if(k)return k(e,!0);c=Error("Cannot find module '"+e+"'");throw c.code="MODULE_NOT_FOUND",c;}c=d[e]={h:{}};f[e][0].call(c.h,function(a){var c=f[e][1][a];return m(c?c:a)},c,c.h,p,f,d,g)}return d[e].h}for(var k="function"==typeof require&&require,h=0;h<g.length;h++)m(g[h]);return m})({1:[function(l){var f={service:l("../src/service"),client:l("../src/client"),sa:l("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return f}):self.threads=f},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(l,f){function d(c,a,b){if(!(this instanceof d))return new d(c,a);"object"==typeof c&&(b=c.timeout,a=c.endpoint,c=c.v);this.id=e();this.v=c;this.timeout=b;this.endpoint=a||this.endpoint;if(!this.endpoint)throw g(1);this.O(this.endpoint);this.i=new Set;this.m=h.m(this.id).b("_push",this.fa.bind(this))}function g(c,a){a=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",
2:'Unable to establish a connection with "'+a[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+a[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[c])}var m=l("./message/port-adaptors"),k=l("./emitter"),h=l("./message"),e=l("./utils").J;f.h=d;d.prototype={connect:function(){var c=this;if(this.A)return this.A;var a=new MessageChannel;this.channel=a.port1;this.channel.start();var b={B:this.id,
v:this.v};return this.A=this.message("_connect").set("transfer",[a.port2]).set("data",b).l(a.port1).send().then(function(a){a.event.target===c.channel?c.O(c.channel):(c.channel.close(),delete c.channel);c.m.l(c.port)}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(2,c.v),console.error(a.message));throw a;})},disconnect:function(c){var a=this;if(!this.A)return Promise.resolve();c={f:c&&c.f,data:this.id};this.ba();return this.message("_disconnect").set(c).send().then(function(){return a.ea()})},
method:function(c,a){var b=this;a=[].slice.call(arguments,1);return this.connect().then(function(){return b.message("_method").set({s:b.v,data:{name:c,W:a}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(3,c),console.error(a.message));throw a;})},F:function(c){c(this,{Emitter:k,uuid:e});return this},message:function(c){var a=this,b=h(c).set("port",this.port).b("response",function(){return a.i.delete(b)}).b("cancel",function(){return a.i.delete(b)});this.timeout&&
b.set("timeout",this.timeout);this.i.add(b);return b},ba:function(){this.i.forEach(function(c){c.cancel()});this.i.clear()},ga:function(){var c=[];this.i.forEach(function(a){return c.push(a.ta)});return Promise.all(c)},fa:function(c){this.M(c.data.type,c.data.data)},ea:function(){var c=this;delete this.A;this.ga().then(function(){c.channel&&c.channel.close();c.M("disconnected")})},O:function(c){this.port=m(c)},g:function(){var c=this;return this.disconnect().then(function(){c.ca||(c.ca=!0,c.m.g(),
c.Z(),c.port=c.endpoint=c.m=null)})},Z:k.prototype.o,M:k.prototype.a};d.prototype.b=function(c,a){var b=this;this.connect().then(function(){k.prototype.b.call(b,c,a);b.message("_on").set("noRespond",!0).set("data",{name:c,B:b.id}).send(b.port)});return this};d.prototype.o=function(c,a){var b=this;this.connect().then(function(){k.prototype.o.call(b,c,a);b.message("_off").set("noRespond",!0).set("data",{name:c,B:b.id}).send(b.port)});return this};var b=d.prototype;b.destroy=b.g;b.plugin=b.F;b.method=
b.method;b.connect=b.connect;b.disconnect=b.disconnect;b.on=b.b;b.off=b.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(l,f){function d(f){if(f)return Object.assign(f,d.prototype)}f.h=d;d.prototype={b:function(d,f){this.c||(this.c={});this.c[d]||(this.c[d]=[]);this.c[d].push(f);return this},o:function(d,f){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[d];break;default:var g=this.c[d];if(!g)return;var e=g.indexOf(f);~e&&g.splice(e,
1)}return this},a:function(d,f){if(this.c)for(var g=this.c[d]||[],g=g.concat(this.c["*"]||[]),e=0;e<g.length;e++)g[e].call(this,f,d);return this}};var g=d.prototype;g.off=g.o;g.on=g.b},{}],4:[function(l,f,d){function g(a){this.N=!1;this.L=null;this.C=[];this.j=b();this.onMessage=this.onMessage.bind(this);this.D=this.D.bind(this);"object"===typeof a?this.oa(a):this.pa(a)}function m(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=
this.unlisten.bind(this)}function k(a){return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var h=l("./port-adaptors"),e=l("../emitter");l=l("../utils");var b=l.j,c=l.J;d=f.h=function(a){return new g(a)};d.m=function(a){return new m(a)};d.K=m;d.i=g;g.prototype={timeout:1E3,pa:function(a){this.id=c();this.type=a;this.ma=!1;this.s="*"},oa:function(a){this.P=!1;this.S(a.source||a.target);this.event=a;Object.assign(this,
a.data)},S:function(a){this.H=h(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},na:function(){return{id:this.id,type:this.type,data:this.data,s:this.s,f:this.f}},U:function(){this.defaultPrevented=!0},send:function(a){if(this.ma)throw k(1);var b=this.na(),c=!this.f;this.port=a?h(a):this.port;if(!this.port)throw k(3);c?(this.l(this.port),this.L=setTimeout(this.D,this.timeout)):this.j.resolve();this.port.postMessage(b,this.aa());return this.j.G},
aa:function(){return this.qa||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.N&&this.la(a)},D:function(){this.ua||this.j.reject(k(4));this.I()},l:function(a){a=h(a);a.addListener(this.onMessage);this.C.push(a);return this},w:function(){var a=this;this.C.forEach(function(b){return b.removeListener(a.onMessage)});this.C=[]},cancel:function(){this.I();this.N=!0;this.a("cancel")},I:function(){clearTimeout(this.L);this.w()},u:function(a){function b(a){e({type:"resolve",
value:a})}function c(a){e({type:"reject",value:a&&a.message||a})}function e(a){d.response=a;d.H.postMessage({id:d.id,response:a},d.qa)}if(this.P)throw k(2);if(this.H&&!this.f){var d=this;this.P=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},T:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.u(a.value)})},la:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.I();this.j[this.response.type](c);
this.a("response",b)}};f=g.prototype;f.forward=f.T;f.respond=f.u;f.preventDefault=f.U;f.cancel=f.cancel;f.send=f.send;f.set=f.set;e(g.prototype);m.prototype={l:function(a){a=h(a||self,{m:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.l),this.ports.add(a),this},w:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.w)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.da(a.data.s)&&(a=new g(a),this.a("message",a),!a.defaultPrevented))try{this.a(a.type,
a)}catch(b){throw a.u(b),b;}},da:function(a){return a==this.name||"*"==a||"*"==this.name},g:function(){this.w();delete this.name;return this}};f=m.prototype;f.listen=f.l;f.unlisten=f.w;f.destroy=f.g;e(m.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(l,f){function d(b){this.target=b}function g(b,c,a){b.addEventListener(c,a)}var m=l("../utils").j;f.h=function(b,c){if(!b)throw Error({1:"target is undefined"}[1]);if(b&&b.addListener)return b;var a=h[b.constructor.name];return a?
a(b,c):new d(b)};var k=d.prototype={constructor:d,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},h={HTMLIFrameElement:function(b){var c=e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,e){c.then(function(){b.contentWindow.postMessage(a,
"*",e)})}}},ra:function(b,c){function a(){var a=m();b.postMessage("ready?");g(b,"message",function n(c){"ready"==c.data&&(b.removeEventListener("message",n),a.resolve())});return a.G}var e=c&&c.m,d=c&&c.ready,d=d||e?Promise.resolve():a();e&&(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:k.addListener,removeListener:k.removeListener,postMessage:function(a,c){d.then(function(){return b.postMessage(a,c)})}}},Window:function(b,
c){var a=c&&c.ready||b===self,a=a?Promise.resolve():e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,e){a.then(function(){return b.postMessage(c,"*",e)})}}},SharedWorker:function(b){b.port.start();return new d(b.port)},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};
self.addEventListener("connect",this.onconnect)},removeListener:function(c,a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},e=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);b.postMessage("load","*")});g(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var e=b.contentWindow||
b;if(c.has(e)||e==window.parent)return Promise.resolve();var d=m();g(window,"message",function n(b){"load"==b.data&&b.source==e&&(window.removeEventListener("message",n),d.resolve())});return d.G}}}()},{"../utils":7}],6:[function(l,f){function d(e){if(!(this instanceof d))return new d(e);k.K.call(this,e);this.clients={};this.methods={};this.b("_disconnect",this.onDisconnect.bind(this)).b("_connect",this.ha.bind(this)).b("_method",this.ia.bind(this)).b("_off",this.ja.bind(this)).b("_on",this.ka.bind(this));
this.g=this.g.bind(this)}function g(e){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[e])}var m=l("./utils").J,k=l("./message"),h=k.K;f.h=d;d.prototype=Object.create(h.prototype);d.prototype.method=function(e,b){this.methods[e]=b;return this};d.prototype.X=function(e,b,c){var a=this;this.Y(function(d){c&&!~c.indexOf(d.id)||a.push(e,b,d.id,{f:!0})});return this};d.prototype.push=function(e,b,c,a){a=a&&a.f;var d=this.$(c);return k("_push").set({s:c,f:a,data:{type:e,data:b}}).send(d.port)};
d.prototype.Y=function(e){for(var b in this.clients)e(this.clients[b])};d.prototype.$=function(e){return this.clients[e]};d.prototype.ha=function(e){var b=e.data,c=b.B;if(c&&b.v===this.name&&!this.clients[c]&&(this.a("before-connect",e),!e.defaultPrevented)){if(b=(b=e.event.ports)&&b[0])e.S(b),this.l(b),b.start();this.V(c,e.H);e.u();this.a("connected",c)}};d.prototype.onDisconnect=function(e){var b=this.clients[e.data];b&&(this.a("before-disconnect",e),e.defaultPrevented||(this.R(b.id),e.u(),this.a("disconnected",
b.id)))};d.prototype.ia=function(e){this.a("before-method",e);if(!e.defaultPrevented){var b=e.data,c=b.name,a,d=this.methods[c];if(!d)throw g(4,c);try{a=d.apply(this,b.W)}catch(f){a=f}e.u(a)}};d.prototype.ka=function(e){this.a("on",e.data)};d.prototype.ja=function(e){this.a("off",e.data)};d.prototype.V=function(e,b){this.clients[e]={id:e,port:b}};d.prototype.R=function(e){delete this.clients[e]};d.prototype.F=function(e){e(this,{uuid:m});return this};d.prototype.disconnect=function(e){this.R(e.id);
k("disconnect").set({s:e.id,f:!0}).send(e.port)};d.prototype.g=function(){delete this.clients;this.w();this.o()};h=d.prototype;h.broadcast=h.X;h.destroy=h.g;h.method=h.method;h.plugin=h.F},{"./message":4,"./utils":7}],7:[function(l,f,d){d.J=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var f=16*Math.random()|0;return("x"==d?f:f&3|8).toString(16)})};d.j=function(){var d={};d.G=new Promise(function(f,k){d.resolve=f;d.reject=k});return d}},{}]},{},[1]);
