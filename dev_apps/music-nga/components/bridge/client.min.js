(function(p){if("object"===typeof exports&&"undefined"!==typeof module)module.b=p();else if("function"===typeof define&&define.la)define([],p);else{var g;"undefined"!==typeof window?g=window:"undefined"!==typeof global?g=global:"undefined"!==typeof self?g=self:g=this;g.na=p()}})(function(){return function g(d,e,f){function m(k,c){if(!e[k]){if(!d[k]){var b="function"==typeof require&&require;if(!c&&b)return b(k,!0);if(l)return l(k,!0);b=Error("Cannot find module '"+k+"'");throw b.code="MODULE_NOT_FOUND",
b;}b=e[k]={b:{}};d[k][0].call(b.b,function(a){var b=d[k][1][a];return m(b?b:a)},b,b.b,g,d,e,f)}return e[k].b}for(var l="function"==typeof require&&require,n=0;n<f.length;n++)m(f[n]);return m}({1:[function(g,d){var e=d.b=self.bridge||{};e.client=g("../src/client");"u"!="undefined"[0]?(void 0)([],function(){return e}):self.bridge=e},{"../src/client":2}],2:[function(g,d){function e(b,a,h){if(!(this instanceof e))return new e(b,a,h);"object"==typeof b&&(a=b.endpoint,h=b.timeout,b=b.s);this.id=k();this.s=
b;this.timeout=h;this.endpoint=a||this.endpoint;if(!this.endpoint)throw f(1);this.K(this.endpoint);this.c=new Set;this.h=n.h(this.id).g("_push",this.$.bind(this))}function f(b,a){a=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+a[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+a[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[b])}
var m=g("./message/port-adaptors"),l=g("./emitter"),n=g("./message"),k=g("./utils").N;d.b=e;e.prototype={connect:function(){var b=this;if(this.j)return this.j;var a=new MessageChannel;this.channel=a.port1;this.channel.start();var h={I:this.id,s:this.s};return this.j=this.message("_connect").set("transfer",[a.port2]).set("data",h).i(a.port1).send().then(function(a){a.event.target===b.channel?b.K(b.channel):(b.channel.close(),delete b.channel);b.h.i(b.port)}).catch(function(a){"timeout"==(a&&a.message)&&
(a=f(2,b.s),console.error(a.message));throw a;})},G:function(b){var a=this;if(!this.j)return Promise.resolve();b={m:b&&b.m,data:this.id};this.X();return this.message("_disconnect").set(b).send().then(function(){return a.Z()})},U:function(b,a){var h=this;a=[].slice.call(arguments,1);return this.connect().then(function(){return h.message("_method").set({w:h.s,data:{name:b,ma:a}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&(a=f(3,b),console.error(a.message));
throw a;})},ja:function(b){b(this,{Emitter:l,uuid:k});return this},message:function(b){var a=this,h=n(b).set("port",this.port).set("timeout",this.timeout).g("response",function(){return a.c.delete(h)}).g("cancel",function(){return a.c.delete(h)});this.c.add(h);return h},X:function(){this.c.forEach(function(b){b.cancel()});this.c.clear()},ba:function(){var b=[];this.c.forEach(function(a){return b.push(a.oa)});return Promise.all(b)},$:function(b){this.J(b.data.type,b.data.data)},Z:function(){var b=
this;delete this.j;this.ba().then(function(){b.channel&&b.channel.close();b.J("disconnected")})},K:function(b){this.port=m(b)},v:function(){var b=this;return this.G().then(function(){b.Y||(b.Y=!0,b.h.v(),b.V(),b.port=b.endpoint=b.h=null)})},V:l.prototype.o,J:l.prototype.l};e.prototype.g=function(b,a){var h=this;this.connect().then(function(){l.prototype.g.call(h,b,a);h.message("_on").set("noRespond",!0).set("data",{name:b,I:h.id}).send(h.port)});return this};e.prototype.o=function(b,a){var h=this;
this.connect().then(function(){l.prototype.o.call(h,b,a);h.message("_off").set("noRespond",!0).set("data",{name:b,I:h.id}).send(h.port)});return this};var c=e.prototype;c.destroy=c.v;c.plugin=c.ja;c.method=c.U;c.connect=c.connect;c.disconnect=c.G;c.on=c.g;c.off=c.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":6}],3:[function(g,d){function e(d){if(d)return Object.assign(d,e.prototype)}d.b=e;e.prototype={g:function(d,e){this.a||(this.a={});this.a[d]||(this.a[d]=[]);this.a[d].push(e);
return this},o:function(d,e){if(this.a)switch(arguments.length){case 0:this.a={};break;case 1:delete this.a[d];break;default:var f=this.a[d];if(!f)return;var g=f.indexOf(e);~g&&f.splice(g,1)}return this},l:function(d,e){if(this.a)for(var f=this.a[d]||[],f=f.concat(this.a["*"]||[]),g=0;g<f.length;g++)f[g].call(this,e,d);return this}};var f=e.prototype;f.off=f.o;f.on=f.g},{}],4:[function(g,d,e){function f(a){this.H=!1;this.A=[];this.f=c();this.onMessage=this.onMessage.bind(this);this.B=this.B.bind(this);
"object"===typeof a?this.ga(a):this.ha(a)}function m(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function l(a){return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var n=g("./port-adaptors"),k=g("../emitter");g=g("../utils");var c=g.f,b=g.N;e=d.b=function(a){return new f(a)};e.h=function(a){return new m(a)};e.j=
m;e.c=f;f.prototype={ha:function(a){this.id=b();this.type=a;this.ca=!1;this.w="*"},ga:function(a){this.L=!1;this.fa(a.source||a.target);this.event=a;Object.assign(this,a.data)},fa:function(a){this.M=n(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},da:function(){return{id:this.id,type:this.type,data:this.data,w:this.w,m:this.m}},P:function(){this.defaultPrevented=!0},send:function(a){if(this.ca)throw l(1);var b=this.da(),c=!this.m;this.port=
a?n(a):this.port;if(!this.port)throw l(3);c?(this.i(this.port),this.ea()):this.f.resolve();this.port.postMessage(b,this.T());return this.f.C},ea:function(){!1!==this.timeout&&(this.R=setTimeout(this.B,this.timeout||1E3))},S:function(){clearTimeout(this.R)},T:function(){return this.ia||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.H&&this.aa(a)},B:function(){this.pa||this.f.reject(l(4));this.F()},i:function(a){a=n(a);a.addListener(this.onMessage);this.A.push(a);
return this},u:function(){var a=this;this.A.forEach(function(b){return b.removeListener(a.onMessage)});this.A=[]},cancel:function(){this.F();this.H=!0;this.l("cancel")},F:function(){this.S();this.u()},D:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){f.response=a;f.M.postMessage({id:f.id,response:a},f.ia)}if(this.L)throw l(2);if(this.M&&!this.m){var f=this;this.L=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},
O:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.D(a.value)})},aa:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.F();this.f[this.response.type](c);this.l("response",b)}};d=f.prototype;d.forward=d.O;d.respond=d.D;d.preventDefault=d.P;d.cancel=d.cancel;d.send=d.send;d.set=d.set;k(f.prototype);m.prototype={i:function(a){a=n(a||self,{h:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.i),this.ports.add(a),
this},u:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.u)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.W(a.data.w)&&(a=new f(a),this.l("message",a),!a.defaultPrevented))try{this.l(a.type,a)}catch(b){throw a.D(b),b;}},W:function(a){return a==this.name||"*"==a||"*"==this.name},v:function(){this.u();delete this.name;return this}};d=m.prototype;d.listen=d.i;d.unlisten=d.u;d.destroy=d.v;k(m.prototype)},{"../emitter":3,"../utils":6,"./port-adaptors":5}],
5:[function(g,d){function e(c){this.target=c}function f(c,b,a){c.addEventListener(b,a)}var m=g("../utils").f;d.b=function(c,b){if(!c)throw Error({1:"target is undefined"}[1]);if(c&&c.addListener)return c;var a=n[c.constructor.name];return a?a(c,b):new e(c)};var l=e.prototype={constructor:e,addListener:function(c){this.target.addEventListener("message",c)},removeListener:function(c){this.target.removeEventListener("message",c)},postMessage:function(c,b){this.target.postMessage(c,b)}},n={HTMLIFrameElement:function(c){var b=
k(c);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,d){b.then(function(){c.contentWindow.postMessage(a,"*",d)})}}},ka:function(c,b){function a(){var a=m();c.postMessage("ready?");f(c,"message",function q(b){"ready"==b.data&&(c.removeEventListener("message",q),a.resolve())});return a.C}var d=b&&b.h,e=b&&b.ready,e=e||d?Promise.resolve():a();d&&(c.postMessage("ready"),f(c,"message",function(a){"ready?"==
a.data&&c.postMessage("ready")}));return{target:c,addListener:l.addListener,removeListener:l.removeListener,postMessage:function(a,b){e.then(function(){return c.postMessage(a,b)})}}},Window:function(c,b){var a=b&&b.ready||c===self,a=a?Promise.resolve():k(c);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(b,d){a.then(function(){return c.postMessage(b,"*",d)})}}},SharedWorker:function(c){c.port.start();
return new e(c.port)},SharedWorkerGlobalScope:function(){var c=[];return{postMessage:function(){},addListener:function(b,a){this.onconnect=function(b){b=b.ports[0];c.push(b);b.start();a(b)};self.addEventListener("connect",this.onconnect)},removeListener:function(b,a){self.removeEventListener("connect",this.onconnect);c.forEach(function(b){b.close();a(b)})}}}},k=function(){if("undefined"!=typeof window){var c=window.opener||window.parent,b=new WeakSet;c!=self&&f(window,"DOMContentLoaded",function h(){window.removeEventListener("DOMContentLoaded",
h);c.postMessage("load","*")});f(self,"message",function(c){return"load"==c.data&&b.add(c.source)});return function(c){var d=c.contentWindow||c;if(b.has(d)||d==window.parent)return Promise.resolve();var e=m();f(window,"message",function q(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",q),e.resolve())});return e.C}}}()},{"../utils":6}],6:[function(g,d,e){e.N=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var e=16*Math.random()|0;return("x"==
d?e:e&3|8).toString(16)})};e.f=function(){var d={};d.C=new Promise(function(e,g){d.resolve=e;d.reject=g});return d}},{}]},{},[1])(1)});
